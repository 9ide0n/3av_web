- hosts:
    - webservers

  pre_tasks:
  - include_vars: "{{item}}"
    with_items:
    - group_vars/all
    - pipeline/{{ pipeline }}/secrets.yml
    - pipeline/{{ pipeline }}/vars.yml
    - pipeline/{{ pipeline }}/taskqueue_vars.yml
    - pipeline/{{ pipeline }}/web_vars.yml
    - pipeline/{{ pipeline }}/db_vars.yml
    - group_vars/webservers
    - group_vars/dbservers
  # - include_tasks: tasks/load_vars.yml

  roles:

    - role: 91de0n.virtualenv

    - role: 91de0n.djangopg
      djangopg_template_localsettingspy: "templates/all/djangopg/local_settings.py.j2"

    - role: 91de0n.memcached
      memcached_listen_ip: "{{project_memcached_host}}"
      when: project_cache or project_task

    - role: 91de0n.gunicorn
      gunicorn_template_gunicornconfpy: "templates/all/gunicorn/gunicorn.conf.py.j2"
      when: project_gunicorn

    - role: 91de0n.supervisor
      supervisor_conf_name: "gunicorn"
      supervisor_template_supervisorconf: "templates/all/supervisor/gunicorn.conf.j2"
      when: project_gunicorn

    - role: 91de0n.nginx
      nginx_template_nginxconf: "templates/all/nginx/nginx.conf.j2"
      when: project_nginx
