- hosts:
    - dbservers

  pre_tasks:
  - include_vars: "{{item}}"
    with_items:
    - group_vars/all
    - pipeline/{{ pipeline }}/secrets.yml
    - pipeline/{{ pipeline }}/vars.yml
    - pipeline/{{ pipeline }}/db_vars.yml
    - group_vars/dbservers
  # - include_tasks: tasks/load_vars.yml
    tags: always
    
  roles:
    - role: 91de0n.postgrespro
      postgrespro_template_pghbaconf: "templates/{{pipeline}}/postgrespro/pg_hba.conf.j2"
      postgrespro_template_postgresqlconf: "templates/{{pipeline}}/postgrespro/postgresql.conf.j2"
      when: "project_provider != 'aws'"

    - role: 91de0n.postgrespro_initdb
      postgrespro_initdb_dbname: "{{project_dbname}}"
      postgrespro_initdb_dbuser: "{{project_dbuser}}"
      postgrespro_initdb_dbpass: "{{project_dbpass}}"
      postgrespro_initdb_locale: "{{locale}}"
      when: "project_provider != 'aws'"
